# Makefile for example app using libzeep
#
# Copyright Maarten L. Hekkelman, UMC St. Radboud 2008-2013.
#        Copyright Maarten L. Hekkelman, 2014-2019
# Distributed under the Boost Software License, Version 1.0.
#    (See accompanying file LICENSE_1_0.txt or copy at
#          http://www.boost.org/LICENSE_1_0.txt)
#
# Use the make.config file in the uplevel directory to
# change the settings for this build

SHELL := /bin/bash

firstTarget: all

CXX					= @CXX@
CXXFLAGS			= @CXXFLAGS@ @CPPFLAGS@ @ZEEP_CFLAGS@ @PTHREAD_CFLAGS@ @PQXX_CFLAGS@ @PQ_CFLAGS@ @BOOST_CPPFLAGS@ @MAILIO_CFLAGS@ @SSL_CFLAGS@
LDFLAGS				= @LDFLAGS@ @BOOST_LDFLAGS@ @PTHREAD_CFLAGS@
LIBS				= @LIBS@ \
					  @PQXX_LIBS@ \
					  @PQ_LIBS@ \
					  @ZEEP_LIBS@ \
					  @BOOST_LDFLAGS@ \
					  @BOOST_IOSTREAMS_LIB@ \
					  @BOOST_PROGRAM_OPTIONS_LIB@ \
					  @BOOST_DATE_TIME_LIB@ \
					  @MAILIO_LIBS@ \
					  @SSL_LIBS@

prefix				= @prefix@
exec_prefix			= @exec_prefix@
libdir				= @libdir@
includedir			= @includedir@

GNUmakefile: config.status GNUmakefile.in
	$(SHELL) ./config.status

config.status: configure
	$(SHELL) ./config.status --recheck

configure: configure.ac
	autoconf

# main build variables
CXXFLAGS            += -Wall -Wno-multichar

# Use the DEBUG flag to build debug versions of the code
DEBUG               = @DEBUG@

ifeq "$(DEBUG)" "1"
DEFINES				+= DEBUG
CXXFLAGS            += -g -O0
LDFLAGS				+= -g
else
CXXFLAGS			+= -O3
DEFINES				+= NDEBUG
endif

# targets

VPATH += src:test

CXXFLAGS			+= $(DEFINES:%=-D%)

CXXFLAGS			+= -I ../squeeze/include

OBJDIR = obj
ifeq "$(DEBUG)" "1"
	OBJDIR	:= $(OBJDIR).dbg
endif

$(OBJDIR):
	mkdir -p $(OBJDIR)

MRC					= @MRC@

APPLICATION = @PACKAGE_NAME@

OBJECTS = $(APPLICATION:%=$(OBJDIR)/%.o) \
	$(APPLICATION:%=$(OBJDIR)/%_rsrc.o) \
	$(OBJDIR)/binom.o \
	$(OBJDIR)/bowtie.o \
	$(OBJDIR)/db-connection.o \
	$(OBJDIR)/fisher.o \
	$(OBJDIR)/genome-browser.o \
	$(OBJDIR)/job-scheduler.o \
	$(OBJDIR)/refseq.o \
	$(OBJDIR)/screen-analyzer.o \
	$(OBJDIR)/screen-creator.o \
	$(OBJDIR)/screen-data.o \
	$(OBJDIR)/screen-server.o \
	$(OBJDIR)/screen-service.o \
	$(OBJDIR)/screen-qc.o \
	$(OBJDIR)/user-service.o \
	$(OBJDIR)/utils.o
	
-include $(OBJECTS:%.o=%.d)

$(OBJECTS:.o=.d):

$(OBJDIR)/%.o: %.cpp | src/mrsrc.h $(OBJDIR)
	@ echo ">>" $<
	@ $(CXX) -MD -c -o $@ $< $(CFLAGS) $(CXXFLAGS)

src/mrsrc.h:
	$(MRC) --header > $@

all: $(APPLICATION)
.PHONY: all

# version info
REVISION = $(shell git log --pretty=format:%h --max-count=1)
REVISION_FILE = version-info-$(REVISION).txt

$(REVISION_FILE):
	rm -f version-info-*.txt
	git describe --match=build --dirty > $@
	git log --pretty=medium --date=iso8601 -1 >> $@

rsrc:
	@ mkdir -p $@

rsrc/version.txt: $(REVISION_FILE) | rsrc
	cp $? $@

RSRC = docroot/ rsrc/ rsrc/version.txt

# yarn rules
# SCRIPTS = $(shell find webapp -name '*.js')
SCRIPTS = \
	webapp/index.js \
	webapp/screen.js \
	webapp/create-screen.js \
	webapp/edit-screen.js \
	webapp/sl-screen.js \
	webapp/gene-selection.js \
	webapp/gene-finder.js \
	webapp/similar-finder.js \
	webapp/cluster-finder.js \
	webapp/compare-3.js \
	webapp/admin-user.js \
	webapp/admin-group.js \
	webapp/admin-screen.js \
	webapp/user-screen.js \
	webapp/genome-browser.js \
	webapp/qc.js

WEBAPP_FILES = $(SCRIPTS)
SCRIPT_FILES = $(SCRIPTS:webapp/%.js=docroot/scripts/%.js)

ifneq ($(DEBUG),1)
WEBPACK_OPTIONS = --env.PRODUCTIE
endif

$(subst .js,%js,$(SCRIPT_FILES)): $(subst .js,%js,$(WEBAPP_FILES))
	yarn webpack $(WEBPACK_OPTIONS)

$(SCRIPT_FILES): \
	webapp/genome-viewer.js

$(OBJDIR)/$(APPLICATION)_rsrc.o: $(RSRC) $(SCRIPT_FILES) src/mrsrc.h
	$(MRC) -o $@ $(RSRC) --verbose

$(APPLICATION): %: $(OBJECTS)
	@ echo '->' $@
	@ $(CXX) -o $@ $^ $(LDFLAGS) $(LIBS)

.PHONY: clean
clean:
	rm -rf $(OBJDIR)/* $(APPLICATION)

.PHONY: distclean
distclean: clean
	rm -f config.status config.cache config.log configure.lineno config.status.lineno
	rm -f GNUmakefile

.PHONY: FORCE
FORCE:

.PHONY: help
help:
	echo $(REVISION)
